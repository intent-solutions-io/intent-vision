# IntentVision Agent Engine Deployment
#
# Beads Task: intentvision-9xh
#
# CI/CD workflow for deploying ADK agents to Vertex AI Agent Engine.
# Following bobs-brain patterns:
# - R4: CI-only deployment (no manual deploys)
# - R8: Drift detection first
#
# Triggers:
# - Push to main (deploy to staging)
# - Manual dispatch (deploy to any environment)
# - Pull request (validate only, no deploy)

name: Agent Engine Deploy

on:
  push:
    branches:
      - main
    paths:
      - 'adk/**'
      - '.github/workflows/agent-engine-deploy.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'adk/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      agent:
        description: 'Agent to deploy (or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - orchestrator
          - metric-analyst
          - alert-tuner
          - onboarding-coach
      action:
        description: 'Deployment action'
        required: true
        default: 'update'
        type: choice
        options:
          - create
          - update

env:
  PROJECT_ID: intentvision
  LOCATION: us-central1
  STAGING_BUCKET: gs://intentvision-agent-staging
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # R8: Drift Detection First
  # ==========================================================================
  drift-detection:
    name: R1-R8 Drift Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run drift detection
        run: |
          chmod +x adk/scripts/ci/check_nodrift.sh
          adk/scripts/ci/check_nodrift.sh

  # ==========================================================================
  # ARV Gate: Acceptance/Regression/Validation
  # ==========================================================================
  arv-gate:
    name: ARV Gate Validation
    runs-on: ubuntu-latest
    needs: drift-detection
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run ARV gate
        run: |
          python3 adk/scripts/ci/check_arv_minimum.py

  # ==========================================================================
  # Test: Run pytest suite
  # ==========================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: arv-gate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd adk
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run tests
        run: |
          cd adk
          pytest tests/ -v --tb=short
        env:
          PROJECT_ID: intentvision-test
          LOCATION: us-central1
          ENV: test

  # ==========================================================================
  # Deploy: Agent Engine Deployment (main branch only)
  # ==========================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [drift-detection, arv-gate, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: staging
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to Agent Engine (staging)
        run: |
          python3 adk/scripts/ci/deploy_inline_source.py \
            --agent all \
            --env staging \
            --action update \
            --project ${{ env.PROJECT_ID }} \
            --location ${{ env.LOCATION }} \
            --staging-bucket ${{ env.STAGING_BUCKET }}

  # ==========================================================================
  # Deploy: Manual deployment to any environment
  # ==========================================================================
  deploy-manual:
    name: Manual Deploy
    runs-on: ubuntu-latest
    needs: [drift-detection, arv-gate, test]
    if: github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Deploy to Agent Engine
        run: |
          python3 adk/scripts/ci/deploy_inline_source.py \
            --agent ${{ github.event.inputs.agent }} \
            --env ${{ github.event.inputs.environment }} \
            --action ${{ github.event.inputs.action }} \
            --project ${{ env.PROJECT_ID }} \
            --location ${{ env.LOCATION }} \
            --staging-bucket ${{ env.STAGING_BUCKET }}

  # ==========================================================================
  # PR Validation (no deploy)
  # ==========================================================================
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    needs: [drift-detection, arv-gate, test]
    if: github.event_name == 'pull_request'
    steps:
      - name: Validation summary
        run: |
          echo "PR Validation Complete"
          echo "========================"
          echo "Drift Detection: PASSED"
          echo "ARV Gate: PASSED"
          echo "Tests: PASSED"
          echo ""
          echo "Ready for merge to main (will trigger staging deployment)"
